// XDomain - v0.5.5 - https://github.com/jpillora/xdomain
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2013
!function(a,b){!function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o=[].slice;e="before",d="after",h="readyState",g="Invalid number or parameters. Please see API documentation.",(n=Array.prototype).indexOf||(n.indexOf=function(a){var b,c,d,e;for(b=d=0,e=this.length;e>d;b=++d)if(c=this[b],c===a)return b;return-1}),f=function(a){var b,d,e;return d={},e=function(a){return d[a]||[]},b={listeners:function(a){return Array.prototype.slice.call(e(a))},on:function(a,b,f){d[a]=e(a),d[a].indexOf(b)>=0||(f=f===c?d[a].length:f,d[a].splice(f,0,b))},off:function(a,b){var c;c=e(a).indexOf(b),-1!==c&&e(a).splice(c,1)},fire:function(){var b,c,d,f,g,h;for(c=arguments[0],b=2<=arguments.length?o.call(arguments,1):[],h=e(c),f=0,g=h.length;g>f;f++)d=h[f],d.apply(a,b)}}},l=f(),m={},m[e]=function(a,b){return l.on(e,a,b)},m[d]=function(a,b){return l.on(d,a,b)},i=function(a,b){var c,d,e,f,g,h;switch(null==b&&(b={}),typeof a){case"object":d=[];for(e in a)f=a[e],d.push(""+e+":	"+f);return d.join("\n");case"string":for(d=a.split("\n"),g=0,h=d.length;h>g;g++)c=d[g],/([^:]+):\s*(.+)/.test(c)&&(b[RegExp.$1]||(b[RegExp.$1]=RegExp.$2));return b}},m.headers=i,k=function(b){var c;c=a[b],c&&(a[b]=function(a){return"string"!=typeof a||/\.XMLHTTP/.test(a)?j(new c(a)):void 0})},k("ActiveXObject"),k("XMLHttpRequest"),j=function(a){var b,j,k,m,n,o,p,q,r,s,t,u,v,w,x,y,z;if(0===l.listeners(e).length&&0===l.listeners(d).length)return a;for(v=!1,s={headers:{}},t=null,w=f(),r=function(){p.status=t.status,p.statusText=t.statusText,t.headers||(t.headers={})},q=function(){p.responseType=t.type||"",p.response=t.data||null,p.responseText=t.text||t.data||"",p.responseXML=t.xml||null},k=function(){var b,c,d,e;t.status=a.status,t.statusText=a.statusText,d=i(a.getAllResponseHeaders()),e=[];for(b in d)c=d[b],t.headers[b]?e.push(void 0):e.push(t.headers[b]=c);return e},j=function(){return t.type=a.responseType,t.text=a.responseText,t.data=a.response||t.text,t.xml=a.responseXML},m=0,u=function(a){var b,c,e;return o(),b=function(){for(;a>m&&4>m;)p[h]=++m,2===m&&r(),4===m&&q(),w.fire("readystatechange"),4===m&&w.fire("load")},4>a?b():(c=l.listeners(d),e=function(){var a;if(!c.length)return b();if(a=c.shift(),2===a.length)return a(s,t),e();if(3===a.length)return a(s,t,e);throw g},e(),void 0)},b=function(b){var c,d,e;c={};for(d in b)e=b[d],c[d]=e===a?p:e;return c},o=function(){var b,d,e,f,g;for(g=["timeout"],e=0,f=g.length;f>e;e++)d=g[e],a[d]&&s[d]===c&&(s[d]=a[d]);for(d in p)b=p[d],"function"==typeof b&&/^on(\w+)/.test(d)&&w.on(RegExp.$1,b)},a.onreadystatechange=function(){"unknown"!=typeof a.status&&2===a[h]&&k(),4===a[h]&&(v=!1,k(),j(),u(a[h]))},z=["abort","progress"],x=0,y=z.length;y>x;x++)n=z[x],a["on"+n]=function(a){return w.fire(n,b(a))};return p={withCredentials:!1,response:null,status:0},p.addEventListener=function(a,b){return w.on(a,b)},p.removeEventListener=w.off,p.dispatchEvent=function(){},p.open=function(a,b,c){s.method=a,s.url=b,s.async=c,u(1)},p.send=function(b){var c,d,f;s.body=b,f=function(){var b,c,d;t={headers:{}},v=!0,a.open(s.method,s.url,s.async),s.timeout&&(a.timeout=s.timeout),d=s.headers;for(b in d)c=d[b],a.setRequestHeader(b,c);a.send(s.body)},c=l.listeners(e),d=function(){var a,b;if(!c.length)return f();if(a=function(a){return"object"!=typeof a||"number"!=typeof a.status?d():(t=a,u(4),void 0)},b=c.shift(),1===b.length)return a(b(s));if(2===b.length)return b(s,a);throw g},d()},p.abort=function(){v&&a.abort(),w.fire("abort",arguments)},p.setRequestHeader=function(a,b){s.headers[a]=b},p.getResponseHeader=function(a){return t.headers[a]},p.getAllResponseHeaders=function(){return i(t.headers)},p.upload=f(),p},a.xhook=m}(a,b);var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;for(i=location.protocol+"//"+location.host,z=function(b){var c;return b="xdomain ("+i+"): "+b,c=a.console=a.console||{},c.warn?c.warn(b):alert(b)},H=["postMessage","JSON"],B=0,E=H.length;E>B;B++)if(j=H[B],!a[j])return z("requires '"+j+"' and this browser does not support it"),void 0;for(d="V0",l=function(){return(Math.random()*Math.pow(2,32)).toString(16)},q=function(a){return/(https?:\/\/[^\/]+)(\/.*)?/.test(a)?{origin:RegExp.$1,path:RegExp.$2}:null},y=function(a){var b;return a instanceof RegExp?a:(b=a.toString().replace(/\W/g,function(a){return"\\"+a}).replace(/\\\*/g,".+"),new RegExp("^"+b+"$"))},o=function(c){return b.addEventListener?a.addEventListener("message",c):a.attachEvent("onmessage",c)},u=function(a){return JSON.stringify(a)},k=function(a){return JSON.parse(a)},n=null,f=function(a){var b,c;null===n&&(n={},v());for(b in a)c=a[b],n[b]=c},v=function(){return o(function(a){var b,c,d,e,f,g,h,i,j,l,m,o,p;g="null"===a.origin?"*":a.origin,i=null;for(d in n){l=n[d];try{if(e=y(d),e.test(g)){i=y(l);break}}catch(r){}}if(!i)return z("blocked request from: '"+g+"'"),void 0;if(b=a.source,f=k(a.data),m=f.msg,h=q(m.url),!h||!i.test(h.path))return z("blocked request to path: '"+h.path+"' by regex: "+l),void 0;j=new XMLHttpRequest,j.open(m.method,m.url),j.onreadystatechange=function(){var a;if(4===j.readyState)return a={status:j.status,statusText:j.statusText,type:"",text:j.responseText,headers:xhook.headers(j.getAllResponseHeaders())},b.postMessage(u({id:f.id,msg:a}),g)},m.timeout&&(j.timeout=m.timeout),p=m.headers;for(c in p)o=p[c],j.setRequestHeader(c,o);return j.send(m.body||null)}),a===a.parent?z("slaves must be in an iframe"):a.parent.postMessage("XPING_"+d,"*")},x=null,g=function(a){var b,c;null===x&&(x={},w());for(b in a)c=a[b],x[b]=c},w=function(){return o(function(a){var b;return null!=(b=e.prototype.frames[a.origin])?b.recieve(a):void 0}),xhook.before(function(a,b){var c,d;return d=q(a.url),d&&x[d.origin]?(a.async===!1&&z("sync not supported"),c=new e(d.origin,x[d.origin]),c.send(a,b),void 0):b()})},e=function(){function a(a,c){return this.origin=a,this.proxyPath=c,this.frames[this.origin]?this.frames[this.origin]:(this.frames[this.origin]=this,this.listeners={},this.frame=b.createElement("iframe"),this.frame.id=this.frame.name="xdomain-"+l(),this.frame.src=this.origin+this.proxyPath,this.frame.setAttribute("style","display:none;"),b.body.appendChild(this.frame),this.waits=0,this.waiters=[],this.ready=!1,void 0)}return a.prototype.frames={},a.prototype.post=function(a){this.frame.contentWindow.postMessage(a,this.origin)},a.prototype.listen=function(a,b){if(this.listeners[a])throw"already listening for: "+a;this.listeners[a]=b},a.prototype.unlisten=function(a){delete this.listeners[a]},a.prototype.recieve=function(a){var b,c;return/^XPING(_(V\d+))?$/.test(a.data)?RegExp.$2!==d?(z("your master is not compatible with your slave, check your xdomain.js verison"),void 0):(this.ready=!0,void 0):(c=k(a.data),(b=this.listeners[c.id])?(this.unlisten(c.id),b(c.msg),void 0):(z("unkown message ("+c.id+")"),void 0))},a.prototype.send=function(a,b){var c=this;this.readyCheck(function(){var d;return d=l(),c.listen(d,function(a){return b(a)}),c.post(u({id:d,msg:a}))})},a.prototype.readyCheck=function(a){var b,d=this;return this.ready?a():(this.waiters.push(a),1===this.waiters.length&&(b=function(){if(!d.ready){if(d.waits++>=A.timeout/c)throw"Timeout connecting to iframe: "+d.origin;return setTimeout(b,c)}for(;d.waiters.length;)d.waiters.shift()()},b()),void 0)},a}(),A=function(a){a&&(a.masters&&f(a.masters),a.slaves&&g(a.slaves))},A.parseUrl=q,A.origin=i,A.timeout=15e3,c=100,a.xdomain=A,I=b.getElementsByTagName("script"),C=0,F=I.length;F>C;C++)if(t=I[C],/xdomain/.test(t.src))for(J=["","data-"],D=0,G=J.length;G>D;D++){if(r=J[D],h=t.getAttribute(r+"slave")){if(p=q(h),!p)return;s={},s[p.origin]=p.path,g(s);break}h=t.getAttribute(r+"master"),h&&(m={},m[h]=/./,f(m))}}(window,document);